apiVersion: v1
kind: Pod
metadata:
  name: neighborly-rbac-allowed
  namespace: library-k8s
  labels:
    app.kubernetes.io/name: neighborly-library
    app.kubernetes.io/component: test
    app.kubernetes.io/part-of: rbac-demo
spec:
  restartPolicy: Never
  serviceAccountName: neighborly-rbac-allowed
  automountServiceAccountToken: true
  containers:
    - name: curl
      image: curlimages/curl:8.5.0
      imagePullPolicy: IfNotPresent
      command:
        - sh
        - -lc
        - |
          set -eu
          TOKEN="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
          NS="$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)"
          CACERT="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          URL="https://kubernetes.default.svc/api/v1/namespaces/${NS}/pods?limit=1"
          CODE="$(curl -sS -o /tmp/body -w "%{http_code}" --cacert "$CACERT" -H "Authorization: Bearer $TOKEN" "$URL")"
          echo "HTTP_CODE=$CODE"
          head -c 300 /tmp/body || true
          echo
          if [ "$CODE" = "200" ]; then
            echo "OK: RBAC allowed (pods list)."
            exit 0
          fi
          echo "ERROR: expected 200, got $CODE"
          exit 1
